###第十天：

####第十天草稿：

RabbitMQ

需求：
如何应用 RabbitMQ
商品，访问压力太大，放入缓存
传统解决方案：
1）直接通过数据库查询。（淘汰）
2）静态页面，将jsp生成html代码。
将数据库中的动态内容，生成html静态文件，就放在磁盘上。
（不需要访问数据库，不需要动态拼接内容）
当商品修改时，动态生成html静态文件，覆盖磁盘下文件。
问题：占用大量的磁盘空间，难以搬迁。分流。（淘汰）
3）freemarker、velocity模版
模版语言，形成模版，动态内容自动拼接进去。渲染过程。
效率高，内部有优化。（很多的网站正在使用）
4）访问最快，不想要磁盘文件。将信息放在 redis 中，
当前访问最频繁的放到内存中，redis 会自己有机制，历史最久，
不会有遗存。

商品实现 redis 缓存。
1）写缓存，应该是用户第一次进行查询时（电商），增加商品时写入 redis （门户）
2）读缓存，在查询时，应该先判断 redis 中是否有商品信息，有直接返回，
无到数据库查询，执行上面的第一条。
3）当商品更新时，缓存什么时候进行更新呢？
可以在后台，更新完数据，就顺便更新缓存。
RabbitMQ ，将修改的信息放入 MQ ，消息处理时可能造成时间差，
用户访问的信息，是 redis 中的，可能和数据库中的信息已经不一致了，
但这种情况大多数时可以接受。延时操作，对整个系统的性能，影响小。
消息队列可以延时一段时间，延迟数秒，减轻系统整体的访问压力。

将 RabbitMQ 和 Spring 整合
1）依赖包
2）配置文件 ConnectionFactory, Connection, Channel, Queue, Exchange
路由 direct 模式，配置链接参数 host, port, username, password, virtual host
Rabbit-server
3）写入 rabbitmqTemplate。利用它写消息。

商品更新使用 RabbitMQ
1）利用 template 写消息。后台商品修改时 service，写MQ
2）通过配置文件来配置监听，有它的消息触发，
配置触发后，调用业务的方法。
3）怎么更新 redis 缓存？删除，第一次查询进行设置缓存。

自定义交换机名称 exchange="itemDirectExchange"

修改成功后，设置发送商品修改的消息，消息应该存放什么内容？
1）直接存放商品的信息 （不建议）
2）只放修复的商品的 itemId （推荐）
MQ队列中的信息越少，处理越快

RabbitMQ 方式
使系统松耦合
[图片]


全文检索
1） 和 like 比较
like %陈% ，没有使用索引
like 陈%，使用了索引
2）文字太多，从头查询到尾。文章，文件

lucene
工具集
先根据文章创建很多索引文件。
用户进行查询时，直接到索引文件中进行查询，查询到返回文章的引用。
引用分页，每条引用中，搜到的关键字为加亮，点击引用，展示文章的详细内容。

倒排索引
传统的方式，是由查询的关键字去找文章。
方式变化，由查询的关键字去找索引的位置，由索引去找文章。
[图片]

分词，扫描文章，将文章中所有的词挑出来

solr
基于 lucene 全文检索
集群，封装 API 方便创建索引，形成一个平台。
war 包

ES
elastic search
吸收 solr 经验，实现了 RESTFul 支持

全文里面有很多内容是无需检索的，（的，吗）+非法词（停止词）

全文检索工具：
lukeall-4.10.2.jar
bat: java -XX:MaxPermSize=512m -jar lukeall-4.10.2.jar
全文检索耗费的内容比较大，配置大一点的启动内存



####第十天总结：
知识回顾：
1）RabbitMQ
Server 

2）商品缓存更新
兵分两路，
a）在业务中，找一个点来写 MQ，商品查询，
rabbitmq 和 spring 进行整合，rabbitTemplate，
可以直接发送消息。（exchange driect 路由方式）设置路由 key，
指定 key，向它发送消息，发送的数据量应该尽量小，最终选择商品id，
消息就被发送到 MQ 的服务器中，消息就被绑定在 exchange 上；
b）在前台的系统中，配置 rebbitmq 和 spring 进行整合，
rabbitmq 配置和发送端不同，而是有自己的配置，
主要不同在于，这里要声明消息队列，绑定队列到交换机上，
消息队列的服务器会自动将，服务其中的消息，按路由 key进行判断，
如果是这个队列的值，就转发到队列中。（自动完成，无需开发者参与，对开发者透明）
在配置中配置了一个监听，当这个消息队列中有消息，
就会触发在配置中指定的类和指定的方法，
消息队列的服务器，会自动调用 spring 容器中的 service 组件 component，
同时将消息传递给调用的方法，还自动转类型。
通过方法的形参，就得到了消息队列中的消息，也就是 itemId，
之后就可以处理业务方法。

3）商品缓存更新
a）直接将商品的信息重新的 set。（不好）
b）直接把 redis 中的内容删除，然后通过业务的第一次访问重新设置

4）全文检索
a）lucene API 工具集合
solr 平台，分布式，
elasticsearch
b）原理，倒排索引，分词
倒排索引，两边扫描，第一遍扫描文档中的所有的词，根据分词词库拆词，形成索引，
第二遍扫描，就进行统计每个次在文档中出现的位置+每个词出现次数
分词，因地制宜，每个国家等都可以扩充分词词库，
停止词。
c）创建索引，Document 相当于数据库表中的一条记录、创建一个 Dir -FSDirectory 目录
在硬盘上创建一个索引的总目录，Analyzer 分词器、可以配置不同的分词器。
d）TextField 分词，StringField 整词

